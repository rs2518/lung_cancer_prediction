import osimport numpy as npimport pandas as pdfrom sklearn.compose import make_column_selector, ColumnTransformerfrom sklearn.preprocessing import OneHotEncoder, StandardScalerROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))PKG = os.path.join(ROOT, "lcml")CLINICAL_INFO_COLS = ["Dataset", "Disease Status", "Gender", "Race",                      "Age", "Stage", "Histology", "Survival Month",                      "Survival", "Smoking", "TNM stage (T)", "TNM stage (N)",                      "TNM stage (M)", "Recurrence", "Others"]STATUS_MAP = {"NSCLC":"Tumour", "Normal":"Non-tumour"}HISTOLOGY_MAP = {"ADC":"ADC",                 "Healthy":"Healthy",                 "LCC":"LCC",                 "SCC":"SCC",                 "Adenosquamous carcinoma":"ASC",                 "Large cell Neuroendocrine carcinoma":"LCNEC",                 "NSCLC-favor adenocarcinoma":"NFA",                 "NSClarge cell carcinoma-mixed":"Mixed",                 "Other":"Other",                 np.nan:np.nan}STAGE_MAP = {" 1A":"1",             " 1B":"1",             " 2A":"2",             " 2B":"2",             "1":"1",             "1A":"1",             "1B":"1",             "2":"2",             "2A":"2",             "2B":"2",             "3A":"3",             "3B":"3",             "4":"4",             "0":"0",             np.nan:np.nan}    # Alternative versionSMOKING_MAP = {"Current":"Current",               "Ever-smoker":"Former",               "Ex-smoker":"Former",               "Former":"Former",               "Never":"Never",               "Never-smoker":"Never",               np.nan:np.nan}# NOTE: Include np.nan to see age distribution among missing values# # Sample IDs from literature (for PlotRLE)# SAMPLE_IDS = [918, 287, 438, 1062, 60, 627, 486, 1046, 1073, 779,#               476, 670, 156, 201, 485, 111, 51, 158, 387, 357,#               117, 869, 637, 270, 749, 54, 403, 471, 386, 1117,#               849, 534, 612, 22, 580, 48, 58, 95, 140, 181,#               420, 973, 939, 283, 936, 221, 507, 651, 266, 1]DATASET_PALETTE = {"GSE10245": "cyan",                   "GSE10445": "brown",                   "GSE10799": "magenta",                   "GSE12667": "yellow",                   "GSE18842": "orange",                   "GSE19188": "lime",                   "GSE28571": "blue",                   "GSE31210": "black",                   "GSE33356": "red",                   "GSE50081": "lightgray"}STATUS_PALETTE = {"Non-tumour": "lime", "Tumour": "red"}GENDER_PALETTE = {"Female":"hotpink", "Male":"dodgerblue"}HISTOLOGY_PALETTE = {"ADC": "blue",                     "ASC": "fuchsia",                     "LCC": "yellow",                     "LCNEC": "orange",                     "NFA": "cyan",                     "SCC": "red",                     "Mixed": "blueviolet",                     "Healthy": "lime",                     "Other": "black",                     "Missing": "lightgray"}SMOKING_PALETTE = {"Never": "dodgerblue",                   "Former": "limegreen",                   "Current":"r",                   "Missing":"lightgray"}# STAGE_PALETTE = {1:"", 2:"", 3:"", 4:"", "Missing":"lightgray"}STAGE_PALETTE = "rocket_r"TRAIN_TEST_PARAMS = dict(test_size=0.3, random_state=103)def create_directory(path):    """Create directory for given path if it doesn't exist    """    if not os.path.exists(path):        os.mkdir(path)        print("Created '{}' directory!".format(path[path.rfind("/")+1:]))# Data loaders# ------------def load_clinical_info():    """Load cleaned version of clinical information dataset    """    data = pd.read_csv("https://figshare.com/ndownloader/files/10449075",                       sep="\t", index_col=0, header=0,                       names=CLINICAL_INFO_COLS)        # Recode features    data["Disease Status"] = data["Disease Status"].map(STATUS_MAP)    # NSCLC/Normal --> Tumour/Non-tumour        data.loc[(data["Histology"]=="Healthy") & (data["Stage"].isnull()),             "Stage"] = "0"    data["Stage_opt"] = data["Stage"].map(dict(STAGE_MAP, **{" pT2N0":1}))    # Optimistic recoding of "Stage" (pT2N0 --> 1B)    data["Stage_pes"] = data["Stage"].map(dict(STAGE_MAP, **{" pT2N0":2}))    # Pessimistic recoding of "Stage" (pT2N0 --> 2A)    data["Smoking_opt"] = data["Smoking"].map(dict(SMOKING_MAP,                                                   **{"Non-smoking":"Never"}))    # Optimistic recoding of "Smoking" (non-smoking --> never)    data["Smoking_pes"] = data["Smoking"].map(dict(SMOKING_MAP,                                                   **{"Non-smoking":"Former"}))    # Pessimistic recoding of "Smoking" (non-smoking --> former)    data.loc[(data["Disease Status"]=="Non-tumour")        & (data["Histology"].isnull()), "Histology"] = "Healthy"                # Disease subtype for healthy patients should be "Healthy"    data["Histology"] = data["Histology"].map(HISTOLOGY_MAP)        data["Age"] = np.floor(data["Age"])    # Remove columns    rm = ["Race",          "Survival Month",          "Recurrence",          "Others",          "TNM stage (T)",          "TNM stage (N)",          "TNM stage (M)"]    data.drop(columns=rm, inplace=True)        # Convert "object" columns to "categories"    cols = data.select_dtypes(include=["object"]).columns    for col in cols:        data[col] = data[col].astype("category")        return data.drop(columns=["Stage", "Smoking"])def load_patient_status():    """Load patient status data    """    return pd.read_csv("https://figshare.com/ndownloader/files/9194524",                       index_col=0)def _load_microarray_expr(corrected, filtered):    """Load batch-corrected/batch-uncorrected microarray expression level data    """    if corrected:        if filtered:            url = "https://figshare.com/ndownloader/files/9194527"        else:            url = "https://figshare.com/ndownloader/files/9194533"    else:        if filtered:            raise FileExistsError("No file for batch-uncorrected, "                                  "filtered microarray expression levels")        else:            url = "https://figshare.com/ndownloader/files/9194530"        return pd.read_csv(url, sep="\t").T            def _load_tcga_expr(corrected, filtered):    """Load batch-corrected/batch-uncorrected TCGA expression level data    """    if corrected:        raise FileExistsError("No file(s) for batch-uncorrected TCGA "                              "expression levels")    else:        if filtered:            raise FileExistsError("No file for batch-uncorrected, "                                  "filtered expression levels")        else:            url = "https://figshare.com/ndownloader/files/9194545"                return pd.read_csv(url, sep="\t", index_col=0).Tdef load_expression_data(source="microarray", corrected=True, filtered=True):    """Load microarray/TCGA expression data        If source="microarray", load microarray data. If source="tcga", load     tcga data.    """    if source not in ("microarray", "tcga"):        raise ValueError("Invalid source")            if source=="microarray":        return _load_microarray_expr(corrected=corrected, filtered=filtered)    else:        return _load_tcga_expr(corrected=corrected, filtered=filtered)        def load_de_analysis(source="microarray"):    """Load DE gene analysis results        If source="microarray", load microarray data. If source="tcga", load     tcga data    """    if source not in ("microarray", "tcga"):        raise ValueError("Invalid source")            if source=="microarray":        return pd.read_csv("https://figshare.com/ndownloader/files/9194536",                           sep="\t")    else:        return pd.read_csv("https://figshare.com/ndownloader/files/9194539",                           sep="\t")def get_de_genes():    """Get list of differentially expressed genes from microarray data    """    data = load_de_analysis(source="microarray")    return sorted(data[data["threshold"]!=False].index.to_list())def load_de_rank():    """Load DE gene rankings (compares microarray and tcga DE analyses by gene)    """    return pd.read_csv("https://figshare.com/ndownloader/files/9194542",                       sep="\t")    def load_data(label, expr_only=True, top_genes=True, **expr_kwargs):    """Load dataframe with features and labels        The column in the clinical information set by 'label' is moved to the last    column of the dataframe.    If expr_only=True, load expression data only (no clinical data).    If top_genes=True, filter down expression levels to differentially    expressed genes only.        Pass arguments for load_expression_data() using keyword arguments    """    data = load_clinical_info()    expr = load_expression_data(**expr_kwargs)    if top_genes:        expr = expr.loc[:, get_de_genes()]        if expr_only:        data = data.loc[:, label].to_frame()    data = data.merge(expr, how="inner", left_index=True, right_index=True)        columns = data.columns.to_list()    columns.remove(label)    columns.append(label)    data = data.loc[:, columns]        return data[~data[label].isnull()]    def feature_preprocessor(X):    """Return ColumnTransformer object that preprocesses categorical    and numerical data        OneHotEncoding is applied to categorical features    StandardScaler is applied to numerical features    NOTE: Feature data types must be set beforehand    """    categorical_columns = make_column_selector(dtype_include="category")(X)    numerical_columns = make_column_selector(dtype_include=np.number)(X)        oh = OneHotEncoder()    sc = StandardScaler()    preprocessor = ColumnTransformer([        ("one-hot-encoder", oh, categorical_columns),        ("standard_scaler", sc, numerical_columns)],        verbose_feature_names_out=False)        return preprocessor